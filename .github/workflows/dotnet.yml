name: .NET Build, Test & Publish

on:
    push:
        branches: [main]
        tags: ["v*"]
    pull_request:
        branches: [main]

env:
    DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
    DOTNET_CLI_TELEMETRY_OPTOUT: true
    NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup .NET 10
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "10.0.x"
                  dotnet-quality: "preview"

            - name: Cache NuGet packages
              uses: actions/cache@v4
              with:
                  path: ${{ env.NUGET_PACKAGES }}
                  key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props') }}
                  restore-keys: |
                      ${{ runner.os }}-nuget-

            - name: Restore dependencies
              run: dotnet restore Native.SourceGenerators.slnx

            - name: Build
              run: dotnet build Native.SourceGenerators.slnx --no-restore --configuration Release

            - name: Test
              run: dotnet test Native.SourceGenerators.slnx --no-build --configuration Release --verbosity normal --collect:"XPlat Code Coverage" --results-directory ./coverage

            - name: Upload coverage reports
              uses: codecov/codecov-action@v4
              with:
                  directory: ./coverage
                  fail_ci_if_error: false
              continue-on-error: true

    pack:
        needs: build
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup .NET 10
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "10.0.x"
                  dotnet-quality: "preview"

            - name: Cache NuGet packages
              uses: actions/cache@v4
              with:
                  path: ${{ env.NUGET_PACKAGES }}
                  key: ${{ runner.os }}-nuget-${{ hashFiles('**/Directory.Packages.props') }}
                  restore-keys: |
                      ${{ runner.os }}-nuget-

            - name: Determine version
              id: version
              run: |
                  if [[ $GITHUB_REF == refs/tags/v* ]]; then
                    VERSION=${GITHUB_REF#refs/tags/v}
                  else
                    VERSION="1.0.0-preview.${{ github.run_number }}"
                  fi
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Restore dependencies
              run: dotnet restore Native.SourceGenerators.slnx

            - name: Pack
              run: |
                  dotnet pack src/Native.SourceGenerator.DependencyInjection/Native.SourceGenerator.DependencyInjection.csproj \
                    --configuration Release \
                    --no-restore \
                    -p:PackageVersion=${{ steps.version.outputs.version }} \
                    --output ./artifacts

                  dotnet pack src/Native.SourceGenerator.Configuration/Native.SourceGenerator.Configuration.csproj \
                    --configuration Release \
                    --no-restore \
                    -p:PackageVersion=${{ steps.version.outputs.version }} \
                    --output ./artifacts

                  dotnet pack src/NativeMediator.SourceGenerator.DependencyInjection/NativeMediator.SourceGenerator.DependencyInjection.csproj \
                    --configuration Release \
                    --no-restore \
                    -p:PackageVersion=${{ steps.version.outputs.version }} \
                    --output ./artifacts

                  dotnet pack src/NativeFluentValidator.SourceGenerator.DependencyInjection/NativeFluentValidator.SourceGenerator.DependencyInjection.csproj \
                    --configuration Release \
                    --no-restore \
                    -p:PackageVersion=${{ steps.version.outputs.version }} \
                    --output ./artifacts

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: nuget-packages
                  path: ./artifacts/*.nupkg

    publish:
        needs: pack
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

        steps:
            - name: Download artifacts
              uses: actions/download-artifact@v4
              with:
                  name: nuget-packages
                  path: ./artifacts

            - name: Setup .NET 10
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "10.0.x"
                  dotnet-quality: "preview"

            - name: Publish to NuGet
              run: |
                  for package in ./artifacts/*.nupkg; do
                    dotnet nuget push "$package" \
                      --api-key ${{ secrets.NUGET_API_KEY }} \
                      --source https://api.nuget.org/v3/index.json \
                      --skip-duplicate
                  done

    aot-compatibility:
        needs: build
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup .NET 10
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "10.0.x"
                  dotnet-quality: "preview"

            - name: Create AOT test project
              run: |
                  mkdir -p aot-test
                  cat > aot-test/aot-test.csproj << 'EOF'
                  <Project Sdk="Microsoft.NET.Sdk">
                    <PropertyGroup>
                      <OutputType>Exe</OutputType>
                      <TargetFramework>net10.0</TargetFramework>
                      <PublishAot>true</PublishAot>
                      <IsAotCompatible>true</IsAotCompatible>
                    </PropertyGroup>
                    <ItemGroup>
                      <ProjectReference Include="../src/Native.SourceGenerator.DependencyInjection/Native.SourceGenerator.DependencyInjection.csproj" OutputItemType="Analyzer" ReferenceOutputAssembly="false" />
                      <ProjectReference Include="../src/Native.SourceGenerator.Configuration/Native.SourceGenerator.Configuration.csproj" OutputItemType="Analyzer" ReferenceOutputAssembly="false" />
                    </ItemGroup>
                  </Project>
                  EOF

                  cat > aot-test/Program.cs << 'EOF'
                  using Native.SourceGenerator.DependencyInjection;
                  using Native.SourceGenerator.Configuration;

                  var service = new TestService();
                  Console.WriteLine("AOT Compatibility Test Passed!");

                  public interface ILogger { }
                  public class ConsoleLogger : ILogger { }

                  [Register(typeof(ILogger), ServiceLifetime.Singleton)]
                  public partial class TestService : ILogger
                  {
                  }

                  public partial class ConfigService
                  {
                      [EnvironmentConfig("TEST_VAR", Required = false, DefaultValue = "test")]
                      private readonly string _testVar = "";
                  }
                  EOF

            - name: Verify AOT Compatibility
              run: |
                  cd aot-test
                  dotnet publish -c Release
